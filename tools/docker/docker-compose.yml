name: wreckshop_social

services:
  frontend:
    build:
      context: ../..
      dockerfile: tools/docker/Dockerfile.frontend-root
    container_name: wreckshop-frontend-dev
    environment:
      - API_PROXY_TARGET=http://backend:${BACKEND_PORT:-4002}
      # Intentionally do NOT set VITE_API_BASE_URL, so the browser uses relative /api and Vite proxies
      - VITE_ENABLE_LASTFM=true
      - VITE_ENABLE_SOUNDCLOUD=true
      - VITE_ENABLE_DEEZER=true
      - VITE_ENABLE_YOUTUBE=true
      - VITE_ENABLE_AUDIUS=true
      - VITE_STACK_PROJECT_ID=${STACK_PROJECT_ID:-}
      - VITE_STACK_CLIENT_KEY=${STACK_CLIENT_KEY:-}
      - VITE_STACK_API_URL=${STACK_API_URL:-https://api.stack-auth.com}
      - VITE_STACK_APP_BASE_URL=${STACK_APP_BASE_URL:-https://app.stack-auth.com}
      - VITE_ENABLE_SPOTIFY_SSO=${VITE_ENABLE_SPOTIFY_SSO:-true}
    ports:
      - "${FRONTEND_PORT:-5176}:5176"
    working_dir: /app
    volumes:
      - ../../:/app
      - frontend_node_modules:/app/node_modules
    depends_on:
      - backend
    command: ["sh", "-lc", "npm install --no-audit --no-fund && npm run dev -- --host 0.0.0.0 --port 5176"]

  postgres:
    image: postgres:16-alpine
    container_name: wreckshop-postgres
    environment:
      - POSTGRES_USER=wreckshop
      - POSTGRES_PASSWORD=wreckshop_dev_password
      - POSTGRES_DB=wreckshop
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wreckshop"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: wreckshop-backend-dev
    environment:
      - PORT=${BACKEND_PORT:-4002}
      - DATABASE_URL=postgresql://wreckshop:wreckshop_dev_password@postgres:5432/wreckshop
      - MONGODB_URI=mongodb://mongo:27017/wreckshop
      - REDIS_URL=redis://redis:6379
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=300
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID:-}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET:-}
      - SPOTIFY_REDIRECT_URI=http://localhost:${BACKEND_PORT:-4002}/auth/spotify/callback
      - CORS_ORIGIN=http://localhost:${FRONTEND_PORT:-5176}
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY:-}
      - SOUNDCLOUD_CLIENT_ID=${SOUNDCLOUD_CLIENT_ID:-}
      - LASTFM_API_KEY=${LASTFM_API_KEY:-}
      - STACK_PROJECT_ID=${STACK_PROJECT_ID:-}
      - STACK_CLIENT_KEY=${STACK_CLIENT_KEY:-}
      - STACK_SERVER_KEY=${STACK_SERVER_KEY:-}
      - STACK_WEBHOOK_SECRET=${STACK_WEBHOOK_SECRET:-}
      - STACK_API_URL=${STACK_API_URL:-https://api.stack-auth.com}
    ports:
      - "${BACKEND_PORT:-4002}:4002"
    working_dir: /app
    volumes:
      - ../../backend:/app
      - backend_node_modules:/app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_started
      redis:
        condition: service_started
    command: ["sh", "-lc", "npm install --no-audit --no-fund && npm run dev"]

  mongo:
    image: mongo:7
    container_name: wreckshop-mongo
    volumes:
      - mongo_data:/data/db

  redis:
    image: redis:7-alpine
    container_name: wreckshop-redis
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]

  scripts:
    build:
      context: ../..
      dockerfile: tools/docker/Dockerfile.scripts
    container_name: wreckshop-scripts
    environment:
      - LASTFM_API_KEY=${LASTFM_API_KEY:-}
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY:-}
      - BACKEND_BASE_URL=http://backend:${BACKEND_PORT:-4002}
    working_dir: /app
    volumes:
      - ../../:/app
    depends_on:
      - backend
    # Provide a larger shared memory for Chromium
    shm_size: "2gb"
    command: ["bash", "-lc", "sleep infinity"]

volumes:
  frontend_node_modules:
  backend_node_modules:
  mongo_data:
  postgres_data:
