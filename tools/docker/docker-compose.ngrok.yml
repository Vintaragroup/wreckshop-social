name: wreckshop_social_ngrok

services:
  frontend:
    build:
      context: ../..
      dockerfile: tools/docker/Dockerfile.frontend-ngrok
    container_name: wreckshop-frontend-ngrok
    environment:
      # Use relative URL so Vite proxy can forward API requests to backend
      - VITE_API_BASE_URL=/api
      - VITE_ENABLE_LASTFM=true
      - VITE_ENABLE_SOUNDCLOUD=true
      - VITE_ENABLE_DEEZER=true
      - VITE_ENABLE_YOUTUBE=true
      - VITE_ENABLE_AUDIUS=true
      - VITE_STACK_PROJECT_ID=${STACK_PROJECT_ID:-}
      - VITE_STACK_CLIENT_KEY=${STACK_CLIENT_KEY:-}
      - VITE_STACK_API_URL=${STACK_API_URL:-https://api.stack-auth.com}
      - VITE_STACK_APP_BASE_URL=${STACK_APP_BASE_URL:-https://app.stack-auth.com}
      - VITE_ENABLE_SPOTIFY_SSO=${VITE_ENABLE_SPOTIFY_SSO:-true}
    ports:
      - "${FRONTEND_PORT:-5176}:5176"
    volumes:
      - ../../:/app
      - frontend_node_modules_ngrok:/app/node_modules
    depends_on:
      - backend

  postgres:
    image: postgres:16-alpine
    container_name: wreckshop-postgres-ngrok
    environment:
      - POSTGRES_USER=wreckshop
      - POSTGRES_PASSWORD=wreckshop_dev_password
      - POSTGRES_DB=wreckshop
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_ngrok:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wreckshop"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ../../backend
      dockerfile: Dockerfile
    container_name: wreckshop-backend-ngrok
    environment:
      - PORT=${BACKEND_PORT:-4002}
      - DATABASE_URL=postgresql://wreckshop:wreckshop_dev_password@postgres:5432/wreckshop
      - MONGODB_URI=mongodb://mongo:27017/wreckshop
      - REDIS_URL=redis://redis:6379
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=300
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID:-}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET:-}
      # For ngrok, update callback URL
      - SPOTIFY_REDIRECT_URI=https://wreckshop.ngrok.app/auth/spotify/callback
      # CORS allows ngrok domain
      - CORS_ORIGIN=https://wreckshop.ngrok.app
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY:-}
      - SOUNDCLOUD_CLIENT_ID=${SOUNDCLOUD_CLIENT_ID:-}
      - LASTFM_API_KEY=${LASTFM_API_KEY:-}
      - STACK_PROJECT_ID=${STACK_PROJECT_ID:-}
      - STACK_CLIENT_KEY=${STACK_CLIENT_KEY:-}
      - STACK_SERVER_KEY=${STACK_SERVER_KEY:-}
      - STACK_WEBHOOK_SECRET=${STACK_WEBHOOK_SECRET:-}
      - STACK_API_URL=${STACK_API_URL:-https://api.stack-auth.com}
    ports:
      - "${BACKEND_PORT:-4002}:4002"
    working_dir: /app
    volumes:
      - ../../backend:/app
      - backend_node_modules_ngrok:/app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_started
      redis:
        condition: service_started
    command: ["sh", "-lc", "npm install --no-audit --no-fund && npm run dev"]

  mongo:
    image: mongo:7
    container_name: wreckshop-mongo-ngrok
    volumes:
      - mongo_data_ngrok:/data/db

  redis:
    image: redis:7-alpine
    container_name: wreckshop-redis-ngrok
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]

volumes:
  frontend_node_modules_ngrok:
  backend_node_modules_ngrok:
  mongo_data_ngrok:
  postgres_data_ngrok:
